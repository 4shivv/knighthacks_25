<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VisionGuide - iPhone LiDAR Navigation</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0a0a0a;
      overflow: hidden;
    }
    #root {
      width: 100vw;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    .scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .scrollbar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    .scrollbar::-webkit-scrollbar-thumb {
      background: rgba(0, 255, 136, 0.3);
      border-radius: 4px;
    }
    .scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 255, 136, 0.5);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Icons
    const SmartphoneIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
        <line x1="12" y1="18" x2="12.01" y2="18"></line>
      </svg>
    );

    const ScanIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
        <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
        <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
        <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
        <circle cx="12" cy="12" r="1"></circle>
      </svg>
    );

    const ActivityIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
      </svg>
    );

    const SettingsIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m5.196-14.196L13.5 8.5m-3 3l-3.696 3.696M1 12h6m6 0h6m-14.196 5.196L8.5 13.5m3-3l3.696-3.696"></path>
      </svg>
    );

    const Trash2Icon = () => (
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    );

    const TargetIcon = ({ size = 14 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <circle cx="12" cy="12" r="6"></circle>
        <circle cx="12" cy="12" r="2"></circle>
      </svg>
    );

    const WifiIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
        <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
        <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
        <line x1="12" y1="20" x2="12.01" y2="20"></line>
      </svg>
    );

    // Color scheme
    const colors = {
      bg: '#0a0a0a',
      card: '#111111',
      border: '#00ff88',
      text: '#ffffff',
      textDim: '#888888',
      accent: '#00ff88',
      danger: '#ff3366',
      warning: '#ffb800',
      info: '#00d4ff',
    };

    // Action color mapping
    const actionColors = {
      'MOVE': colors.accent,
      'FORWARD': colors.accent,
      'TURN': colors.warning,
      'LEFT': colors.warning,
      'RIGHT': colors.warning,
      'STOP': colors.danger,
      'OBSTACLE': colors.danger,
      'SCANNING': colors.info,
      'TARGET': colors.accent,
      'REVERSE': colors.warning,
      'LIDAR': colors.info,
      'DEPTH': colors.info,
    };

    const getActionColor = (actionText) => {
      const upperAction = actionText.toUpperCase();
      for (const [key, color] of Object.entries(actionColors)) {
        if (upperAction.includes(key)) return color;
      }
      return colors.accent;
    };

    function VisionGuide() {
      const [mission, setMission] = useState('Find the red mug');
      const [actions, setActions] = useState([]);
      const [isConnected, setIsConnected] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      
      const [backendUrl, setBackendUrl] = useState('http://192.168.1.100:5000');
      const [iphoneUrl, setIphoneUrl] = useState('http://192.168.1.102:8080');
      const [streamEndpoint, setStreamEndpoint] = useState('/stream');
      const [streamError, setStreamError] = useState(false);
      const [imageRefresh, setImageRefresh] = useState(0);
      
      const [targetDetected, setTargetDetected] = useState(false);
      const [targetLabel, setTargetLabel] = useState('');
      const [targetConfidence, setTargetConfidence] = useState(0);
      const [obstacleDetected, setObstacleDetected] = useState(false);
      const [currentDirection, setCurrentDirection] = useState('IDLE');
      
      const [lidarActive, setLidarActive] = useState(false);
      const [depthDataAvailable, setDepthDataAvailable] = useState(false);
      const [pointCloudQuality, setPointCloudQuality] = useState('High');
      
      const logRef = useRef(null);
      const pollInterval = useRef(null);

      const testConnection = async () => {
        try {
          const response = await fetch(`${backendUrl}/state`);
          if (response.ok) {
            setIsConnected(true);
            return true;
          }
        } catch (error) {
          console.error('Connection failed:', error);
        }
        setIsConnected(false);
        return false;
      };

      const fetchAction = async () => {
        try {
          const response = await fetch(`${backendUrl}/state`);
          if (response.ok) {
            const data = await response.json();
            
            if (data.action) {
              setActions(prev => {
                if (prev.length > 0 && prev[0].text === data.action) {
                  return prev;
                }
                const newAction = {
                  text: data.action,
                  time: new Date().toLocaleTimeString('en-US', { hour12: false }),
                  color: getActionColor(data.action)
                };
                return [newAction, ...prev.slice(0, 19)];
              });
            }
            
            if (data.target_detected !== undefined) setTargetDetected(data.target_detected);
            if (data.target_label) setTargetLabel(data.target_label);
            if (data.target_confidence !== undefined) setTargetConfidence(data.target_confidence);
            if (data.obstacle_detected !== undefined) setObstacleDetected(data.obstacle_detected);
            if (data.direction) setCurrentDirection(data.direction);
            if (data.lidar_active !== undefined) setLidarActive(data.lidar_active);
            if (data.depth_available !== undefined) setDepthDataAvailable(data.depth_available);
          }
        } catch (error) {
          console.error('Failed to fetch action:', error);
        }
      };

      const clearLog = () => {
        setActions([]);
      };

      useEffect(() => {
        testConnection();
        pollInterval.current = setInterval(() => {
          fetchAction();
        }, 500);
        
        return () => {
          if (pollInterval.current) clearInterval(pollInterval.current);
        };
      }, [backendUrl]);

      useEffect(() => {
        if (logRef.current) {
          logRef.current.scrollTop = 0;
        }
      }, [actions]);

      const handleImageError = () => {
        setStreamError(true);
        setTimeout(() => {
          setImageRefresh(prev => prev + 1);
        }, 2000);
      };

      const handleImageLoad = () => {
        setStreamError(false);
      };

      const SettingsModal = () => (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }}>
          <div style={{
            backgroundColor: colors.card,
            border: `1px solid ${colors.border}`,
            borderRadius: '12px',
            padding: '32px',
            maxWidth: '500px',
            width: '90%'
          }}>
            <h2 style={{ fontSize: '20px', marginBottom: '24px', color: colors.text }}>
              System Configuration
            </h2>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
              <div>
                <label style={{ 
                  display: 'block',
                  fontSize: '13px',
                  color: colors.textDim,
                  marginBottom: '8px'
                }}>
                  Backend URL
                </label>
                <input
                  type="text"
                  value={backendUrl}
                  onChange={(e) => setBackendUrl(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '10px',
                    backgroundColor: colors.bg,
                    border: `1px solid ${colors.textDim}`,
                    borderRadius: '6px',
                    color: colors.text,
                    fontSize: '13px',
                    fontFamily: 'monospace'
                  }}
                />
              </div>
              
              <div>
                <label style={{ 
                  display: 'block',
                  fontSize: '13px',
                  color: colors.textDim,
                  marginBottom: '8px'
                }}>
                  iPhone Stream URL
                </label>
                <input
                  type="text"
                  value={iphoneUrl}
                  onChange={(e) => setIphoneUrl(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '10px',
                    backgroundColor: colors.bg,
                    border: `1px solid ${colors.textDim}`,
                    borderRadius: '6px',
                    color: colors.text,
                    fontSize: '13px',
                    fontFamily: 'monospace'
                  }}
                />
              </div>
              
              <div>
                <label style={{ 
                  display: 'block',
                  fontSize: '13px',
                  color: colors.textDim,
                  marginBottom: '8px'
                }}>
                  Stream Endpoint
                </label>
                <input
                  type="text"
                  value={streamEndpoint}
                  onChange={(e) => setStreamEndpoint(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '10px',
                    backgroundColor: colors.bg,
                    border: `1px solid ${colors.textDim}`,
                    borderRadius: '6px',
                    color: colors.text,
                    fontSize: '13px',
                    fontFamily: 'monospace'
                  }}
                />
              </div>
              
              <div style={{
                display: 'flex',
                gap: '12px',
                marginTop: '12px'
              }}>
                <button
                  onClick={async () => {
                    const connected = await testConnection();
                    if (connected) {
                      setShowSettings(false);
                    }
                  }}
                  style={{
                    flex: 1,
                    backgroundColor: colors.accent,
                    color: colors.bg,
                    border: 'none',
                    borderRadius: '8px',
                    padding: '12px',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: '600'
                  }}
                >
                  Test & Save
                </button>
                <button
                  onClick={() => setShowSettings(false)}
                  style={{
                    flex: 1,
                    backgroundColor: 'transparent',
                    color: colors.textDim,
                    border: `1px solid ${colors.textDim}`,
                    borderRadius: '8px',
                    padding: '12px',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: '600'
                  }}
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      );

      return (
        <div style={{
          display: 'flex',
          width: '100vw',
          height: '100vh',
          backgroundColor: colors.bg,
          color: colors.text,
          overflow: 'hidden'
        }}>
          {showSettings && <SettingsModal />}
          
          {/* Left Side - Camera Feed */}
          <div style={{
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            padding: '20px',
            gap: '16px',
            minWidth: 0,
            overflow: 'hidden'
          }}>
            {/* Header */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              flexShrink: 0
            }}>
              <div>
                <h1 style={{
                  fontSize: '24px',
                  fontWeight: '700',
                  margin: 0,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '10px'
                }}>
                  <span style={{ color: colors.accent }}>VISION</span>
                  <span>GUIDE</span>
                </h1>
                <p style={{
                  fontSize: '12px',
                  color: colors.textDim,
                  margin: '4px 0 0 0'
                }}>
                  iPhone LiDAR Navigation System
                </p>
              </div>
              
              <button
                onClick={() => setShowSettings(true)}
                style={{
                  backgroundColor: colors.card,
                  border: `1px solid ${colors.border}`,
                  color: colors.accent,
                  borderRadius: '8px',
                  padding: '10px',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                <SettingsIcon />
              </button>
            </div>

            {/* Camera Feed */}
            <div style={{
              flex: 1,
              backgroundColor: colors.card,
              border: `1px solid ${colors.border}`,
              borderRadius: '12px',
              overflow: 'hidden',
              position: 'relative',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              minHeight: 0
            }}>
              {!streamError ? (
                <img
                  key={imageRefresh}
                  src={`${iphoneUrl}${streamEndpoint}?t=${Date.now()}`}
                  alt="iPhone Camera Feed"
                  onError={handleImageError}
                  onLoad={handleImageLoad}
                  style={{
                    width: '100%',
                    height: '100%',
                    objectFit: 'contain'
                  }}
                />
              ) : (
                <div style={{
                  textAlign: 'center',
                  padding: '40px'
                }}>
                  <SmartphoneIcon />
                  <p style={{ color: colors.textDim, fontSize: '14px', marginTop: '16px' }}>
                    Connecting to iPhone stream...
                  </p>
                  <p style={{ color: colors.textDim, fontSize: '11px', marginTop: '8px' }}>
                    URL: {iphoneUrl}{streamEndpoint}
                  </p>
                </div>
              )}

              {/* Overlay indicators */}
              {targetDetected && (
                <div style={{
                  position: 'absolute',
                  top: '12px',
                  left: '12px',
                  backgroundColor: 'rgba(0, 255, 136, 0.9)',
                  color: colors.bg,
                  padding: '6px 12px',
                  borderRadius: '6px',
                  fontSize: '12px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}>
                  <TargetIcon size={14} />
                  TARGET: {targetLabel} ({Math.round(targetConfidence * 100)}%)
                </div>
              )}

              {lidarActive && (
                <div style={{
                  position: 'absolute',
                  top: '12px',
                  right: '12px',
                  backgroundColor: 'rgba(0, 212, 255, 0.9)',
                  color: colors.bg,
                  padding: '6px 12px',
                  borderRadius: '6px',
                  fontSize: '11px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}>
                  <ScanIcon />
                  LiDAR Active
                </div>
              )}

              {obstacleDetected && (
                <div style={{
                  position: 'absolute',
                  bottom: '12px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  backgroundColor: 'rgba(255, 51, 102, 0.9)',
                  color: colors.text,
                  padding: '10px 20px',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600'
                }}>
                  ⚠️ OBSTACLE DETECTED
                </div>
              )}

              <div style={{
                position: 'absolute',
                bottom: '10px',
                right: '10px',
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                padding: '4px 10px',
                borderRadius: '6px',
                fontSize: '11px',
                fontFamily: 'monospace'
              }}>
                {new Date().toLocaleTimeString('en-US', { hour12: false })}
              </div>
            </div>

            {/* Mission Input */}
            <div style={{
              backgroundColor: colors.card,
              border: `1px solid ${colors.border}`,
              borderRadius: '12px',
              padding: '16px',
              flexShrink: 0
            }}>
              <label style={{
                display: 'block',
                fontSize: '11px',
                color: colors.textDim,
                marginBottom: '10px',
                fontWeight: '600',
                letterSpacing: '0.5px'
              }}>
                CURRENT MISSION
              </label>
              <input
                type="text"
                value={mission}
                onChange={(e) => setMission(e.target.value)}
                placeholder="Enter navigation objective..."
                style={{
                  width: '100%',
                  padding: '12px',
                  backgroundColor: colors.bg,
                  border: `1px solid ${colors.accent}`,
                  borderRadius: '8px',
                  color: colors.text,
                  fontSize: '14px'
                }}
              />
            </div>
          </div>

          {/* Right Side - Dashboard */}
          <div 
            className="scrollbar"
            style={{
              width: '420px',
              flexShrink: 0,
              backgroundColor: colors.bg,
              padding: '20px',
              display: 'flex',
              flexDirection: 'column',
              gap: '14px',
              borderLeft: `1px solid ${colors.border}`,
              overflowY: 'auto',
              overflowX: 'hidden'
            }}>
            {/* System Status */}
            <div style={{
              backgroundColor: colors.card,
              border: `1px solid ${colors.border}`,
              borderRadius: '10px',
              padding: '16px'
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                marginBottom: '14px'
              }}>
                <WifiIcon />
                <h3 style={{ fontSize: '13px', fontWeight: '600', margin: 0, letterSpacing: '0.5px' }}>
                  SYSTEM STATUS
                </h3>
              </div>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontSize: '12px', color: colors.textDim }}>Backend</span>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    color: isConnected ? colors.accent : colors.danger
                  }}>
                    {isConnected ? 'Connected' : 'Disconnected'}
                  </span>
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontSize: '12px', color: colors.textDim }}>iPhone Stream</span>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    color: streamError ? colors.danger : colors.accent
                  }}>
                    {streamError ? 'Disconnected' : 'Active'}
                  </span>
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontSize: '12px', color: colors.textDim }}>Direction</span>
                  <span style={{ fontSize: '12px', fontWeight: '600', color: colors.warning }}>
                    {currentDirection}
                  </span>
                </div>
              </div>
            </div>

            {/* LiDAR Status */}
            <div style={{
              backgroundColor: colors.card,
              border: `1px solid ${colors.info}`,
              borderRadius: '10px',
              padding: '16px'
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                marginBottom: '14px'
              }}>
                <ScanIcon />
                <h3 style={{ fontSize: '13px', fontWeight: '600', margin: 0, letterSpacing: '0.5px' }}>
                  LIDAR STATUS
                </h3>
              </div>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontSize: '12px', color: colors.textDim }}>Sensor</span>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    color: lidarActive ? colors.info : colors.textDim
                  }}>
                    {lidarActive ? 'Active' : 'Standby'}
                  </span>
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontSize: '12px', color: colors.textDim }}>Depth Data</span>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    color: depthDataAvailable ? colors.accent : colors.textDim
                  }}>
                    {depthDataAvailable ? 'Available' : 'N/A'}
                  </span>
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontSize: '12px', color: colors.textDim }}>Point Cloud Quality</span>
                  <span style={{ fontSize: '12px', fontWeight: '600', color: colors.info }}>
                    {pointCloudQuality}
                  </span>
                </div>
              </div>
            </div>

            {/* Activity Log */}
            <div style={{
              backgroundColor: colors.card,
              border: `1px solid ${colors.border}`,
              borderRadius: '10px',
              padding: '16px',
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              minHeight: '300px'
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                marginBottom: '14px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <ActivityIcon />
                  <h3 style={{ fontSize: '13px', fontWeight: '600', margin: 0, letterSpacing: '0.5px' }}>
                    ACTIVITY LOG
                  </h3>
                </div>
                
                <button
                  onClick={clearLog}
                  style={{
                    backgroundColor: 'transparent',
                    border: `1px solid ${colors.textDim}`,
                    color: colors.textDim,
                    borderRadius: '6px',
                    padding: '4px 8px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                    fontSize: '10px',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    e.target.style.borderColor = colors.accent;
                    e.target.style.color = colors.accent;
                  }}
                  onMouseLeave={(e) => {
                    e.target.style.borderColor = colors.textDim;
                    e.target.style.color = colors.textDim;
                  }}
                >
                  <Trash2Icon />
                  Clear
                </button>
              </div>

              <div
                ref={logRef}
                className="scrollbar"
                style={{
                  flex: 1,
                  overflowY: 'auto',
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px',
                  minHeight: 0
                }}
              >
                {actions.length === 0 ? (
                  <p style={{
                    color: colors.textDim,
                    fontSize: '12px',
                    textAlign: 'center',
                    marginTop: '20px'
                  }}>
                    {isConnected ? 'Waiting for actions...' : 'Connect to backend to see actions'}
                  </p>
                ) : (
                  actions.map((action, idx) => (
                    <div
                      key={idx}
                      style={{
                        backgroundColor: `${action.color}10`,
                        border: `1px solid ${action.color}40`,
                        borderLeft: `3px solid ${action.color}`,
                        borderRadius: '8px',
                        padding: '10px'
                      }}
                    >
                      <div style={{
                        fontSize: '12px',
                        marginBottom: '4px',
                        fontWeight: '600',
                        color: action.color
                      }}>
                        {action.text}
                      </div>
                      <div style={{
                        fontSize: '10px',
                        color: colors.textDim,
                        fontFamily: 'monospace'
                      }}>
                        {action.time}
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<VisionGuide />, document.getElementById('root'));
  </script>
</body>
</html>
