<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KnightMobile â€” Camera + LiDAR</title>

  <!-- React UMD + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      overflow: hidden;
    }
    #root { width: 100vw; height: 100vh; display: flex; overflow: hidden; }

    .scrollbar::-webkit-scrollbar { width: 10px; }
    .scrollbar::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.03); border-radius: 5px; margin: 4px;
    }
    .scrollbar::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #00ff88 0%, #00cc6a 100%); border-radius: 5px; transition: all .3s ease;
    }
    .scrollbar::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #00ff88 0%, #00ff88 100%);
    }

    .glass {
      background: rgba(17,17,17,0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,255,136,0.2);
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.37);
    }
    .glow { box-shadow: 0 0 20px rgba(0,255,136,0.3); }
    .smooth-transition { transition: all .3s cubic-bezier(.4,0,.2,1); }
    .button-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,255,136,0.3); }

    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.5;} }
    .pulse { animation: pulse 2s cubic-bezier(.4,0,.6,1) infinite; }
    @keyframes slideIn { from{opacity:0; transform: translateY(-10px);} to{opacity:1; transform: translateY(0);} }
    .slide-in { animation: slideIn .3s ease-out; }
    @keyframes livePulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(0,255,136,.7); }
      50% { box-shadow: 0 0 0 8px rgba(0,255,136,0); }
    }
    .live-pulse { animation: livePulse 2s infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }
    .spin { animation: spin 2s linear infinite; }

    .gradient-gold { 
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(255,215,0,0.2);
    }
    .gradient-silver {
      background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(255,255,255,0.2);
    }

    /* Feed grid (two cards side-by-side like your working template) */
    .feed-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      width: 100%;
      min-height: 0;
    }
    .feed-card {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid rgba(0,255,136,0.2);
    }
    .feed-header {
      position: absolute; top: 14px; left: 14px; z-index: 2;
      padding: 8px 14px; border-radius: 10px; font-weight: 800; letter-spacing: .5px;
      font-size: 12px; display: flex; align-items: center; gap: 8px;
    }
    .feed-img {
      width: 100%; height: 60vh; object-fit: contain; background: #000;
      display: block;
    }
    /* Make sure canvas sits on top of the image */
    .feed-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useRef, useState } = React;

    /* ---------- Icons (inline SVGs) ---------- */
    const Icon = {
      Settings: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6m5.196-14.196L13.5 8.5m-3 3l-3.696 3.696M1 12h6m6 0h6m-14.196 5.196L8.5 13.5m3-3l3.696-3.696"/></svg>),
      Wifi: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>),
      Video: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>),
      Scan: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><circle cx="12" cy="12" r="1"/></svg>),
      Activity: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>),
      Trash: () => (<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>),
      Play: () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>),
      Stop: () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="6" width="12" height="12"/></svg>),
      Loader: () => (<svg className="spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>),
      X: () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>),
      Phone: () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>),
      Robot: () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></svg>),
    };

    const colors = {
      bg: '#0a0a0a',
      card: 'rgba(17, 17, 17, 0.7)',
      border: '#00ff88',
      borderDim: 'rgba(0,255,136,0.2)',
      text: '#ffffff',
      textDim: '#888',
      accent: '#00ff88',
      accentGlow: 'rgba(0,255,136,0.3)',
      danger: '#ff3366',
      warning: '#ffb800',
      info: '#00d4ff',
    };

    const actionColors = {
      'MOVE': colors.accent,
      'FORWARD': colors.accent,
      'TURN': colors.warning,
      'LEFT': colors.warning,
      'RIGHT': colors.warning,
      'STOP': colors.danger,
      'OBSTACLE': colors.danger,
      'SCANNING': colors.info,
      'TARGET': colors.accent,
      'REVERSE': colors.warning,
      'LIDAR': colors.info,
      'ANALYZING': colors.info,
      'NAVIGATING': colors.accent,
    };
    const getActionColor = (t) => {
      const u = t.toUpperCase();
      for (const [k, c] of Object.entries(actionColors)) if (u.includes(k)) return c;
      return colors.accent;
    };

    function KnightMobile() {
      // Settings / connectivity
      const [backendUrl, setBackendUrl] = useState('http://localhost:5000');
      const [isConnected, setIsConnected] = useState(false);
      const [showSettings, setShowSettings] = useState(false);

      // Streams: manage camera & lidar independently
      const [camActive, setCamActive] = useState(false);
      const [lidarActive, setLidarActive] = useState(false);
      const [camError, setCamError] = useState(false);
      const [lidarError, setLidarError] = useState(false);

      // Mission & status data
      const [mission, setMission] = useState('Find the red mug');
      const [missionActive, setMissionActive] = useState(false);
      const [missionStatus, setMissionStatus] = useState('IDLE');
      const [missionProgress, setMissionProgress] = useState(0);
      const [actions, setActions] = useState([]);

      // LiDAR stats
      const [scanCount, setScanCount] = useState(0);
      const [lastScanId, setLastScanId] = useState(null);
      const [depthDataAvailable, setDepthDataAvailable] = useState(false);

      // Detections overlay on camera feed
      const [detections, setDetections] = useState([]);
      const camImgRef = useRef(null);
      const camCanvasRef = useRef(null);

      const logRef = useRef(null);
      const pollInterval = useRef(null);

      const addAction = (text, color=null) => {
        const entry = {
          text,
          time: new Date().toLocaleTimeString('en-US', {hour12:false}),
          color: color || getActionColor(text),
        };
        setActions(prev => [entry, ...prev.slice(0, 49)]);
      };

      // Test backend
      const testConnection = async () => {
        try {
          const r = await fetch(`${backendUrl}/api/scans`, { cache: 'no-store' });
          if (r.ok) {
            setIsConnected(true);
            addAction('Backend connected successfully', colors.accent);
            return true;
          }
        } catch (e) {
          console.error(e);
        }
        setIsConnected(false);
        addAction('Backend connection failed', colors.danger);
        return false;
      };

      // Mission control
      const startMission = async () => {
        if (!mission.trim()) {
          addAction('Error: Mission objective is required', colors.danger);
          return;
        }
        try {
          const r = await fetch(`${backendUrl}/api/start_mission`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ mission, timestamp: new Date().toISOString() })
          });
          if (r.ok) {
            setMissionActive(true);
            setMissionStatus('ACTIVE');
            setMissionProgress(0);
            addAction(`Mission started: ${mission}`, colors.accent);
            addAction('Robot is now autonomous', colors.info);
          } else addAction('Failed to start mission', colors.danger);
        } catch (e) {
          console.error(e);
          addAction('Error starting mission', colors.danger);
        }
      };

      const stopMission = async () => {
        try {
          const r = await fetch(`${backendUrl}/api/stop_mission`, { method:'POST' });
          if (r.ok) {
            setMissionActive(false);
            setMissionStatus('STOPPED');
            addAction('Mission stopped by user', colors.warning);
          } else addAction('Failed to stop mission', colors.danger);
        } catch (e) {
          console.error(e);
          addAction('Error stopping mission', colors.danger);
        }
      };

      // Poll backend
      const fetchScans = async () => {
        try {
          const r = await fetch(`${backendUrl}/api/scans`, { cache:'no-store' });
          if (r.ok) {
            const data = await r.json();
            if (Array.isArray(data.scans)) {
              setScanCount(data.scans.length);
              if (data.scans.length) {
                const latest = data.scans[0];
                if (latest?.id !== lastScanId) {
                  setLastScanId(latest.id);
                  setDepthDataAvailable(true);
                  addAction(`LiDAR scan #${latest.id} received`, colors.info);
                }
              }
            }
          }
        } catch (e) {
          console.error('fetchScans', e);
        }
      };

      const fetchMissionStatus = async () => {
        if (!missionActive) return;
        try {
          const r = await fetch(`${backendUrl}/api/mission_status`, { cache:'no-store' });
          if (r.ok) {
            const data = await r.json();
            if (data.status) setMissionStatus(data.status);
            if (typeof data.progress === 'number') setMissionProgress(data.progress);
            if (data.current_action) addAction(data.current_action, getActionColor(data.current_action));
            if (data.completed) {
              setMissionActive(false);
              setMissionStatus('COMPLETED');
              addAction('Mission completed successfully!', colors.accent);
            }
          }
        } catch (e) {
          console.error('fetchMissionStatus', e);
        }
      };

      const fetchDetections = async () => {
        try {
          const r = await fetch(`${backendUrl}/api/detections`, { cache:'no-store' });
          if (r.ok) {
            const data = await r.json();
            setDetections(Array.isArray(data.objects) ? data.objects : []);
          }
        } catch (e) {
          console.error('fetchDetections', e);
        }
      };

      // Draw detection boxes on camera feed
      const drawDetections = () => {
        const img = camImgRef.current;
        const canvas = camCanvasRef.current;
        if (!img || !canvas) return;

        const rect = img.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);

        if (!detections.length || !img.naturalWidth || !img.naturalHeight) return;

        const scaleX = rect.width / img.naturalWidth;
        const scaleY = rect.height / img.naturalHeight;

        detections.forEach(d => {
          const [x,y,w,h] = d.bbox || [0,0,0,0];
          const sx = x * scaleX, sy = y * scaleY, sw = w * scaleX, sh = h * scaleY;

          ctx.strokeStyle = colors.accent;
          ctx.lineWidth = 3;
          ctx.strokeRect(sx, sy, sw, sh);

          const label = `${d.label ?? 'obj'} ${Math.round((d.confidence ?? 0)*100)}%${d.depth ? ` ${d.depth.toFixed(1)}m` : ''}`;
          ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';
          const tw = ctx.measureText(label).width + 12;
          const th = 22;

          ctx.fillStyle = colors.accent;
          ctx.fillRect(sx, Math.max(0, sy - th - 4), tw, th);
          ctx.fillStyle = colors.bg;
          ctx.fillText(label, sx + 6, Math.max(12, sy - 8));
        });
      };

      // Lifecycle
      useEffect(() => { testConnection(); }, []);
      useEffect(() => {
        if (pollInterval.current) clearInterval(pollInterval.current);
        pollInterval.current = setInterval(() => {
          if (isConnected) {
            fetchScans();
            fetchMissionStatus();
            fetchDetections();
          }
        }, 500);
        return () => pollInterval.current && clearInterval(pollInterval.current);
      }, [isConnected, backendUrl, missionActive, lastScanId]);

      useEffect(() => { drawDetections(); }, [detections, camActive]);

      useEffect(() => {
        if (logRef.current) logRef.current.scrollTop = 0;
      }, [actions]);

      // Stream handlers (auto-retry on error)
      const attachRetry = (imgEl, setErr, setActive) => {
        if (!imgEl) return;
        const retry = () => {
          const base = imgEl.src.split('?')[0];
          imgEl.src = `${base}?t=${Date.now()}`;
        };
        imgEl.onerror = () => { setErr(true); setActive(false); setTimeout(retry, 1200); };
        imgEl.onload = () => { setErr(false); setActive(true); drawDetections(); };
      };

      useEffect(() => { attachRetry(camImgRef.current, setCamError, setCamActive); }, [backendUrl]);
      // LiDAR retry will be attached via ref callback on render

      const clearLog = () => setActions([]);

      // Settings modal
      const SettingsModal = () => (
        <div style={{
          position:'fixed', inset:0, background:'rgba(0,0,0,.85)', backdropFilter:'blur(8px)',
          display:'flex', alignItems:'center', justifyContent:'center', zIndex:1000
        }}>
          <div className="glass" style={{ borderRadius:16, padding:36, maxWidth:540, width:'90%' }}>
            <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:28 }}>
              <h2 style={{ fontSize:24, fontWeight:700, letterSpacing:'-.5px' }}>System Configuration</h2>
              <button onClick={() => setShowSettings(false)} className="smooth-transition"
                style={{ background:'transparent', border:'none', color:colors.textDim, cursor:'pointer', padding:8, borderRadius:8 }}>
                <Icon.X/>
              </button>
            </div>

            <div style={{ display:'flex', flexDirection:'column', gap:24 }}>
              <div>
                <label style={{ display:'block', fontSize:13, fontWeight:600, color:colors.text, marginBottom:10 }}>
                  Flask Backend URL
                </label>
                <input type="text" value={backendUrl} onChange={e => setBackendUrl(e.target.value)}
                  placeholder="http://localhost:5000" className="smooth-transition"
                  style={{
                    width:'100%', padding:'14px 16px', background:'rgba(0,0,0,.4)',
                    border:`2px solid ${colors.borderDim}`, borderRadius:10, color:colors.text,
                    fontSize:14, fontFamily:'monospace', outline:'none'
                  }}
                  onFocus={e=>{ e.target.style.borderColor=colors.border; e.target.style.boxShadow=`0 0 0 3px ${colors.accentGlow}`; }}
                  onBlur={e=>{ e.target.style.borderColor=colors.borderDim; e.target.style.boxShadow='none'; }}
                />
              </div>

              <div className="glass" style={{
                padding:16, borderRadius:10, border:'1px solid rgba(0,212,255,.2)', background:'rgba(0,212,255,.05)'
              }}>
                <p style={{ fontSize:13, color:colors.info, margin:0, lineHeight:1.6, display:'flex', gap:10 }}>
                  <span>ðŸ’¡</span><span>Backend should expose /api/stream_camera, /api/stream_lidar, /api/start_mission, /api/stop_mission</span>
                </p>
              </div>

              <div style={{ display:'flex', gap:12 }}>
                <button onClick={async ()=>{ if (await testConnection()) setShowSettings(false); }}
                  className="smooth-transition button-hover"
                  style={{
                    flex:1, background:`linear-gradient(135deg, ${colors.accent} 0%, #00cc6a 100%)`,
                    color:colors.bg, border:'none', borderRadius:10, padding:14, cursor:'pointer',
                    fontSize:15, fontWeight:700, letterSpacing:'0.3px'
                  }}>
                  Test & Save
                </button>
                <button onClick={()=>setShowSettings(false)} className="smooth-transition"
                  style={{
                    flex:1, background:'transparent', color:colors.textDim, border:`2px solid ${colors.borderDim}`,
                    borderRadius:10, padding:14, cursor:'pointer', fontSize:15, fontWeight:600
                  }}
                  onMouseEnter={e=>{ e.currentTarget.style.borderColor=colors.border; e.currentTarget.style.color=colors.border; }}
                  onMouseLeave={e=>{ e.currentTarget.style.borderColor=colors.borderDim; e.currentTarget.style.color=colors.textDim; }}>
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      );

      return (
        <div style={{ display:'flex', width:'100vw', height:'100vh', color:colors.text, overflow:'hidden' }}>
          {showSettings && <SettingsModal />}

          {/* LEFT: Header + side-by-side feeds + Mission Control */}
          <div style={{ flex:1, display:'flex', flexDirection:'column', padding:24, gap:20, minWidth:0, overflow:'hidden' }}>
            {/* Header */}
            <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', flexShrink:0 }}>
              <div>
                <div style={{
                  display:'inline-block', padding:'12px 20px', background:'rgba(255,255,255,.08)',
                  backdropFilter:'blur(10px)', borderRadius:12, border:'1px solid rgba(255,255,255,.15)',
                  boxShadow:'0 4px 16px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1)'
                }}>
                  <h1 style={{ fontSize:32, fontWeight:800, margin:0, display:'flex', alignItems:'center', gap:12, letterSpacing:'-1px' }}>
                    <span className="gradient-gold">KNIGHT</span>
                    <span className="gradient-silver">MOBILE</span>
                  </h1>
                </div>
                <p style={{ fontSize:13, color:colors.textDim, margin:'8px 0 0 4px', letterSpacing:'.5px' }}>
                  Autonomous Robot Navigation System
                </p>
              </div>

              <button onClick={()=>setShowSettings(true)} className="glass smooth-transition button-hover"
                style={{
                  border:`1px solid ${colors.borderDim}`, color:colors.accent, borderRadius:12, padding:12,
                  cursor:'pointer', display:'flex', alignItems:'center', gap:8, backgroundColor:colors.card
                }}>
                <Icon.Settings/>
              </button>
            </div>

            {/* FEED GRID (side-by-side like your working HTML) */}
            <div className="feed-grid" style={{ flex:1, minHeight:0 }}>
              {/* Camera Card */}
              <div className="glass glow feed-card">
                {/* Status pill */}
                <div className={camActive ? 'live-pulse feed-header' : 'feed-header'}
                  style={{
                    background: camActive ? `linear-gradient(135deg, ${colors.accent} 0%, #00cc6a 100%)` : 'rgba(136,136,136,.9)',
                    color: colors.bg
                  }}>
                  <Icon.Video/> {camActive ? 'CAMERA â€” LIVE' : 'CAMERA â€” WAITING'}
                </div>

                {/* Camera Image */}
                {isConnected ? (
                  <>
                    <img
                      ref={camImgRef}
                      className="feed-img"
                      alt="Camera"
                      src={`${backendUrl}/api/stream_camera?t=${Date.now()}`}
                      style={{ background:'#000' }}
                    />
                    {/* Overlay for detections */}
                    <canvas ref={camCanvasRef} className="feed-overlay"></canvas>
                  </>
                ) : (
                  <div style={{ display:'flex', height:'100%', alignItems:'center', justifyContent:'center', flexDirection:'column', gap:10 }}>
                    <div style={{ opacity:.5 }}><Icon.Phone/></div>
                    <p style={{ color:colors.text, fontSize:16, fontWeight:600 }}>Connecting to backend...</p>
                    <p style={{ color:colors.textDim, fontSize:12 }}>{backendUrl}</p>
                  </div>
                )}

                {/* Clock */}
                <div className="glass" style={{
                  position:'absolute', bottom:16, right:16, padding:'8px 14px',
                  borderRadius:8, fontSize:12, fontFamily:'monospace', fontWeight:600,
                  border:`1px solid ${colors.borderDim}`
                }}>
                  {new Date().toLocaleTimeString('en-US',{hour12:false})}
                </div>
              </div>

              {/* LiDAR Card */}
              <div className="glass glow feed-card">
                {/* Status pill */}
                <div className={lidarActive ? 'live-pulse feed-header' : 'feed-header'}
                  style={{
                    background: lidarActive ? `linear-gradient(135deg, ${colors.info} 0%, #0099cc 100%)` : 'rgba(136,136,136,.9)',
                    color: colors.bg
                  }}>
                  <Icon.Scan/> {lidarActive ? 'LiDAR â€” LIVE' : 'LiDAR â€” WAITING'}
                </div>

                {/* LiDAR Image */}
                {isConnected ? (
                  <img
                    className="feed-img"
                    alt="LiDAR"
                    ref={(el)=>{
                      if (!el) return;
                      // Attach retry logic for LiDAR feed
                      const retry = ()=>{ const base = el.src.split('?')[0]; el.src = `${base}?t=${Date.now()}`; };
                      el.onerror = ()=>{ setLidarError(true); setLidarActive(false); setTimeout(retry, 1200); };
                      el.onload  = ()=>{ setLidarError(false); setLidarActive(true); };
                    }}
                    src={`${backendUrl}/api/stream_lidar?t=${Date.now()}`}
                    style={{ background:'#000' }}
                  />
                ) : (
                  <div style={{ display:'flex', height:'100%', alignItems:'center', justifyContent:'center', flexDirection:'column', gap:10 }}>
                    <div style={{ opacity:.5 }}><Icon.Scan/></div>
                    <p style={{ color:colors.text, fontSize:16, fontWeight:600 }}>Connecting to backend...</p>
                    <p style={{ color:colors.textDim, fontSize:12 }}>{backendUrl}</p>
                  </div>
                )}
              </div>
            </div>

            {/* MISSION CONTROL */}
            <div className="glass" style={{
              borderRadius:16, padding:20, flexShrink:0,
              border:`2px solid ${missionActive ? colors.accent : colors.borderDim}`,
              background: missionActive ? 'rgba(0,255,136,.05)' : colors.card
            }}>
              <div style={{ display:'flex', alignItems:'center', gap:10, marginBottom:16 }}>
                <Icon.Robot/>
                <label style={{
                  fontSize:12, color: missionActive ? colors.accent : colors.textDim, fontWeight:700,
                  letterSpacing:'1px', textTransform:'uppercase'
                }}>
                  Mission Control {missionActive && '- ACTIVE'}
                </label>
              </div>

              <input
                type="text" value={mission} onChange={e=>setMission(e.target.value)}
                placeholder="Enter robot objective (e.g., 'Find the red mug')"
                disabled={missionActive} className="smooth-transition"
                style={{
                  width:'100%', padding:'14px 16px', background:'rgba(0,0,0,.4)',
                  border:`2px solid ${colors.borderDim}`, borderRadius:10, color:colors.text, fontSize:15,
                  outline:'none', marginBottom:16, opacity: missionActive ? .6 : 1
                }}
                onFocus={e=>{ if(!missionActive){ e.target.style.borderColor=colors.border; e.target.style.boxShadow=`0 0 0 3px ${colors.accentGlow}`; }}}
                onBlur={e=>{ e.target.style.borderColor=colors.borderDim; e.target.style.boxShadow='none'; }}
              />

              {missionActive && (
                <div style={{ width:'100%', height:8, background:'rgba(0,0,0,.4)', borderRadius:4, overflow:'hidden', marginBottom:16 }}>
                  <div style={{
                    width:`${missionProgress}%`, height:'100%',
                    background:`linear-gradient(90deg, ${colors.accent} 0%, ${colors.info} 100%)`,
                    transition:'width .5s ease'
                  }}/>
                </div>
              )}

              <div style={{ display:'flex', gap:12 }}>
                {!missionActive ? (
                  <button
                    onClick={startMission} disabled={!isConnected} className="smooth-transition button-hover"
                    style={{
                      flex:1, background: isConnected ? `linear-gradient(135deg, ${colors.accent} 0%, #00cc6a 100%)` : 'rgba(136,136,136,.3)',
                      color: isConnected ? colors.bg : colors.textDim, border:'none', borderRadius:10, padding:14,
                      cursor: isConnected ? 'pointer' : 'not-allowed', fontSize:15, fontWeight:700,
                      display:'flex', alignItems:'center', justifyContent:'center', gap:10
                    }}>
                    <Icon.Play/> Start Mission
                  </button>
                ) : (
                  <button onClick={stopMission} className="smooth-transition button-hover"
                    style={{
                      flex:1, background:`linear-gradient(135deg, ${colors.danger} 0%, #cc0033 100%)`,
                      color:colors.text, border:'none', borderRadius:10, padding:14, cursor:'pointer',
                      fontSize:15, fontWeight:700, display:'flex', alignItems:'center', justifyContent:'center', gap:10
                    }}>
                    <Icon.Stop/> Stop Mission
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* RIGHT: System/ LiDAR status + Activity log */}
          <div className="scrollbar" style={{
            width: 440, flexShrink:0, background:'transparent',
            padding:'24px 24px 24px 0', display:'flex', flexDirection:'column', gap:20, overflowY:'auto', overflowX:'hidden'
          }}>
            {/* System Status */}
            <div className="glass" style={{ borderRadius:16, padding:20, border:`1px solid ${colors.borderDim}` }}>
              <div style={{ display:'flex', alignItems:'center', gap:10, marginBottom:18 }}>
                <Icon.Wifi/>
                <h3 style={{ fontSize:14, fontWeight:700, margin:0, letterSpacing:'.5px', textTransform:'uppercase' }}>System Status</h3>
              </div>

              <div style={{ display:'flex', flexDirection:'column', gap:14 }}>
                {/* Backend */}
                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:10, background:'rgba(0,0,0,.2)', borderRadius:8 }}>
                  <span style={{ fontSize:13, color:colors.textDim, fontWeight:500 }}>Backend</span>
                  <div style={{ display:'flex', alignItems:'center', gap:8 }}>
                    <div className={isConnected ? 'pulse' : ''} style={{
                      width:8, height:8, borderRadius:'50%', background: isConnected ? colors.accent : colors.danger
                    }}/>
                    <span style={{ fontSize:13, fontWeight:700, color: isConnected ? colors.accent : colors.danger }}>
                      {isConnected ? 'Connected' : 'Disconnected'}
                    </span>
                  </div>
                </div>

                {/* Camera stream */}
                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:10, background:'rgba(0,0,0,.2)', borderRadius:8 }}>
                  <span style={{ fontSize:13, color:colors.textDim, fontWeight:500 }}>Camera Stream</span>
                  <div style={{ display:'flex', alignItems:'center', gap:8 }}>
                    <div className={camActive ? 'pulse' : ''} style={{
                      width:8, height:8, borderRadius:'50%', background: camActive ? colors.accent : colors.textDim
                    }}/>
                    <span style={{ fontSize:13, fontWeight:700, color: camActive ? colors.accent : colors.textDim }}>
                      {camActive ? 'Live' : 'Waiting'}
                    </span>
                  </div>
                </div>

                {/* LiDAR stream */}
                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:10, background:'rgba(0,0,0,.2)', borderRadius:8 }}>
                  <span style={{ fontSize:13, color:colors.textDim, fontWeight:500 }}>LiDAR Stream</span>
                  <div style={{ display:'flex', alignItems:'center', gap:8 }}>
                    <div className={lidarActive ? 'pulse' : ''} style={{
                      width:8, height:8, borderRadius:'50%', background: lidarActive ? colors.info : colors.textDim
                    }}/>
                    <span style={{ fontSize:13, fontWeight:700, color: lidarActive ? colors.info : colors.textDim }}>
                      {lidarActive ? 'Live' : 'Waiting'}
                    </span>
                  </div>
                </div>

                {/* Mission */}
                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:10, background:'rgba(0,0,0,.2)', borderRadius:8 }}>
                  <span style={{ fontSize:13, color:colors.textDim, fontWeight:500 }}>Mission</span>
                  <span style={{
                    fontSize:13, fontWeight:700, color: missionActive ? colors.accent : colors.textDim,
                    padding:'4px 10px', background: missionActive ? 'rgba(0,255,136,.1)' : 'transparent', borderRadius:6
                  }}>
                    {missionActive ? 'ACTIVE' : 'IDLE'}
                  </span>
                </div>
              </div>
            </div>

            {/* LiDAR Status */}
            <div className="glass" style={{ borderRadius:16, padding:20, border:'2px solid rgba(0,212,255,.3)', background:'rgba(0,212,255,.05)' }}>
              <div style={{ display:'flex', alignItems:'center', gap:10, marginBottom:18 }}>
                <Icon.Scan/>
                <h3 style={{ fontSize:14, fontWeight:700, margin:0, letterSpacing:'.5px', textTransform:'uppercase', color:colors.info }}>
                  LiDAR Status
                </h3>
              </div>

              <div style={{ display:'flex', flexDirection:'column', gap:14 }}>
                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:10, background:'rgba(0,0,0,.2)', borderRadius:8 }}>
                  <span style={{ fontSize:13, color:colors.textDim, fontWeight:500 }}>Total Scans</span>
                  <span style={{ fontSize:18, fontWeight:800, color:colors.accent }}>{scanCount}</span>
                </div>

                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:10, background:'rgba(0,0,0,.2)', borderRadius:8 }}>
                  <span style={{ fontSize:13, color:colors.textDim, fontWeight:500 }}>Last Scan ID</span>
                  <span style={{ fontSize:13, fontWeight:700, color: lastScanId ? colors.info : colors.textDim, fontFamily:'monospace' }}>
                    {lastScanId ?? 'N/A'}
                  </span>
                </div>

                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:10, background:'rgba(0,0,0,.2)', borderRadius:8 }}>
                  <span style={{ fontSize:13, color:colors.textDim, fontWeight:500 }}>Depth Data</span>
                  <span style={{ fontSize:13, fontWeight:700, color: depthDataAvailable ? colors.accent : colors.textDim }}>
                    {depthDataAvailable ? 'Available' : 'N/A'}
                  </span>
                </div>
              </div>
            </div>

            {/* Activity Log */}
            <div className="glass" style={{ borderRadius:16, padding:20, flex:1, display:'flex', flexDirection:'column', minHeight:320, border:`1px solid ${colors.borderDim}` }}>
              <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:18 }}>
                <div style={{ display:'flex', alignItems:'center', gap:10 }}>
                  <Icon.Activity/>
                  <h3 style={{ fontSize:14, fontWeight:700, margin:0, letterSpacing:'.5px', textTransform:'uppercase' }}>Activity Log</h3>
                </div>
                <button onClick={clearLog} className="smooth-transition"
                  style={{
                    background:'transparent', border:`1px solid ${colors.borderDim}`, color:colors.textDim,
                    borderRadius:8, padding:'6px 12px', cursor:'pointer', display:'flex', alignItems:'center', gap:6,
                    fontSize:11, fontWeight:600
                  }}
                  onMouseEnter={e=>{ e.currentTarget.style.borderColor=colors.accent; e.currentTarget.style.color=colors.accent; e.currentTarget.style.backgroundColor='rgba(0,255,136,.1)'; }}
                  onMouseLeave={e=>{ e.currentTarget.style.borderColor=colors.borderDim; e.currentTarget.style.color=colors.textDim; e.currentTarget.style.backgroundColor='transparent'; }}>
                  <Icon.Trash/> Clear
                </button>
              </div>

              <div ref={logRef} className="scrollbar" style={{ flex:1, overflowY:'auto', display:'flex', flexDirection:'column', gap:10, minHeight:0 }}>
                {actions.length === 0 ? (
                  <div style={{ textAlign:'center', padding:'40px 20px', color:colors.textDim }}>
                    <p style={{ fontSize:13, marginBottom:8 }}>
                      {isConnected ? 'Waiting for activity...' : 'Connect to backend to see activity'}
                    </p>
                    <p style={{ fontSize:11, opacity:.6 }}>Robot commands will appear here</p>
                  </div>
                ) : (
                  actions.map((a, i)=>(
                    <div key={i} className="slide-in smooth-transition"
                      style={{
                        background:`linear-gradient(90deg, ${a.color}15 0%, transparent 100%)`,
                        border:`1px solid ${a.color}30`, borderLeft:`4px solid ${a.color}`,
                        borderRadius:10, padding:'12px 14px'
                      }}>
                      <div style={{ fontSize:13, marginBottom:6, fontWeight:600, color:a.color }}>{a.text}</div>
                      <div style={{ fontSize:11, color:colors.textDim, fontFamily:'monospace', fontWeight:500 }}>{a.time}</div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<KnightMobile/>, document.getElementById('root'));
  </script>
</body>
</html>
